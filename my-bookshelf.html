<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的书架 - 增强功能版</title>
    <!--
        引入 Tailwind CSS CDN：
        这是一个CSS框架，帮助你快速构建响应式和美观的界面。
        我们用它来快速布局和样式化页面。
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!--
        引入 Font Awesome 图标库：
        提供各种图标，用于导航栏、社交链接等。
    -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!--
        引入 Three.js 库：
        用于在背景中创建动态的3D粒子效果。
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /*
            -------------------------------------------------------------------
            自定义 CSS 样式部分：
            这里定义了一些额外的CSS规则，用于实现更精细的控制、动画和3D效果，
            这些是纯粹的CSS，与Tailwind CSS配合使用。
            -------------------------------------------------------------------
        */

        /* 全局字体设置 */
        body {
            font-family: 'Inter', sans-serif; /* 设置页面默认字体 */
            background-color: #1a202c; /* 深色背景，与主页保持一致 */
            color: #e2e8f0; /* 浅色文本 */
            scroll-behavior: smooth; /* 平滑滚动 */
            overflow-x: hidden; /* 防止水平滚动条 */
        }

        /* 英雄背景区域 (主视觉区域) */
        .hero-background {
            height: 300px; /* 调整高度以适应二级页面 */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        /* Three.js Canvas 样式 */
        #threejs-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        /* 毛玻璃效果样式 */
        .glass-morphism {
            backdrop-filter: blur(10px) saturate(180%);
            -webkit-backdrop-filter: blur(10px) saturate(180%);
            background-color: rgba(255, 255, 255, 0.15); /* 更透明的白色背景，适应深色背景 */
            border-radius: 12px;
            border: 1px solid rgba(209, 213, 219, 0.1); /* 细边框，更透明 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        /* 导航栏滚动时的样式变化 */
        .navbar-scrolled {
            background-color: rgba(26, 32, 44, 0.95); /* 滚动后背景更实心，深色 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); /* 滚动后阴影更明显 */
        }

        /* 按钮悬停效果 */
        .btn-primary {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .btn-primary:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }

        /*
            -------------------------------------------------------------------
            书籍3D效果相关样式：
            这是实现“拿出打开”3D动画的核心CSS。
            -------------------------------------------------------------------
        */
        /* 定义CSS变量，方便统一管理书本尺寸 */
        :root {
            --book-actual-width: 200px;     /* 书本封面实际宽度 */
            --book-actual-height: 280px;    /* 书本实际高度 */
            --book-thickness: 20px;         /* 书本厚度 (书脊宽度) */
            --book-spacing-x: 1rem;         /* 书本之间的水平间距 */
            --book-spacing-y: 1rem;         /* 书架层之间的垂直间距 */
        }

        .book-shelf-item {
            /* 每个书本容器，代表3D空间中的整本书 */
            perspective: 1000px; /* 定义3D透视效果的深度 */
            cursor: pointer; /* 鼠标悬停时显示手型光标 */
            position: relative;
            height: var(--book-actual-height);
            width: var(--book-thickness); /* 初始宽度设置为书脊厚度 */
            margin: var(--book-spacing-y) var(--book-spacing-x); /* 垂直和水平间距 */
            transform-style: preserve-3d; /* 关键：使子元素在3D空间中定位 */
            /* 初始状态：书本侧着放，书脊朝前，稍微倾斜 */
            transform: rotateX(5deg) rotateY(-80deg);
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 1;
            z-index: 20; /* 确保书本在书架之上 */
            transform-origin: left center; /* 调整 transform-origin 以便旋转时围绕书脊进行 */
            
            /* 波浪动画 */
            animation: waveAnimation 3s ease-in-out infinite;
        }

        /* 波浪动画的关键帧 */
        @keyframes waveAnimation {
            0%, 100% { transform: rotateX(5deg) rotateY(-80deg) translateY(0px); opacity: 1; }
            50% { transform: rotateX(5deg) rotateY(-80deg) translateY(-5px); opacity: 0.95; }
        }

        /* 为每个书本设置不同的动画延迟，创建波浪效果 */
        .book-shelf-item:nth-child(3n+1) { animation-delay: 0s; }
        .book-shelf-item:nth-child(3n+2) { animation-delay: 0.1s; }
        .book-shelf-item:nth-child(3n+3) { animation-delay: 0.2s; }
        .book-shelf-item:nth-child(5n+1) { animation-delay: 0.3s; } /* 更多随机性 */
        .book-shelf-item:nth-child(5n+2) { animation-delay: 0.4s; }
        .book-shelf-item:nth-child(5n+3) { animation-delay: 0.5s; }
        .book-shelf-item:nth-child(5n+4) { animation-delay: 0.6s; }
        .book-shelf-item:nth-child(5n+5) { animation-delay: 0.7s; }


        .book-container { /* 新增容器，用于包裹书本主体和封面，实现整体3D变换 */
            width: 100%; /* 继承父容器 book-shelf-item 的宽度 */
            height: 100%; /* 继承父容器 book-shelf-item 的高度 */
            position: absolute;
            top: 0;
            left: 0;
            transform-style: preserve-3d;
            transform: translateX(calc(var(--book-thickness) / 2));
        }

        .book-body { /* 书本主体：包含书脊、封底和书页，这个部分是相对固定的 */
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
        }

        /* 书本的各个面基础样式 */
        .book-face {
            position: absolute;
            width: 100%; /* 继承父容器 book-container 或 book-body 的宽度 */
            height: 100%;
            backface-visibility: hidden; /* 隐藏背面，防止翻转时内容倒置 */
            background-size: cover;
            background-position: center;
            border-radius: 8px; /* 圆角 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* 封面 */
        .front-cover {
            background-image: url('https://placehold.co/200x280/87CEEB/ffffff?text=Book+Cover'); /* 默认封面图 */
            transform: translateZ(calc(var(--book-thickness) / 2));
            transition: transform 1s ease-in-out; /* 封面翻开动画过渡 */
            transform-origin: left center; /* 封面翻开的旋转中心点为左侧中心 (书脊) */
        }

        /* 封底 */
        .back-cover {
            background-image: url('https://placehold.co/200x280/A9A9A9/ffffff?text=Back+Cover'); /* 默认封底图 */
            transform: rotateY(180deg) translateZ(calc(var(--book-thickness) / 2));
        }

        /* 书脊 (书本的左侧) */
        .book-spine {
            position: absolute;
            width: var(--book-thickness); /* 书脊的实际厚度 */
            height: 100%;
            background-color: #ccc; /* 书脊颜色 */
            transform: rotateY(-90deg) translateZ(calc(var(--book-thickness) / 2));
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            border-radius: 8px 0 0 8px; /* 左侧圆角 */
            display: flex; /* 启用flexbox使书脊上的文本居中 */
            align-items: center; /* 垂直居中 */
            justify-content: center; /* 水平居中 */
            font-size: 0.8rem;
            color: #333;
            writing-mode: vertical-lr; /* 垂直书写模式 (从左到右，从上到下) */
            text-orientation: mixed; /* 混合方向，字符方向保持不变 */
            padding: 5px 0;
            text-align: center;
            white-space: nowrap; /* 防止文本换行 */
            overflow: hidden; /* 隐藏超出书脊的文本 */
            text-overflow: ellipsis; /* 超出部分显示省略号 */
        }

        /* 书本的右侧 (与书脊相对的另一侧) */
        .book-right-side {
            position: absolute;
            width: var(--book-thickness); /* 右侧的实际厚度 */
            height: 100%;
            background-color: #ccc; /* 右侧颜色 */
            transform: rotateY(90deg) translateZ(calc(var(--book-thickness) / 2));
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            border-radius: 0 8px 8px 0; /* 右侧圆角 */
            left: calc(100% - var(--book-thickness)); /* 定位到书本的右边缘 */
        }

        /* 书页部分 */
        .book-pages {
            position: absolute;
            width: calc(var(--book-actual-width) - var(--book-thickness) * 2); /* 页面宽度 (排除书脊和右侧厚度) */
            height: calc(var(--book-actual-height) - 16px); /* 页面高度 */
            background-color: #f8f8f8; /* 页面颜色 */
            top: 8px; /* 页面顶部内缩 */
            left: var(--book-thickness); /* 页面从书脊右侧开始 */
            transform: translateZ(calc(var(--book-thickness) / 2 + 1px)); /* 稍微在封面和封底前面 */
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
            border-radius: 0 4px 4px 0; /* 右侧圆角 */
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #666;
            text-align: center;
        }

        /* `.is-pulled-out` 类：当书本被点击“拿出”时的状态 */
        .book-shelf-item.is-pulled-out {
            /* 模拟拿出并转向正面，同时略微放大 */
            transform: translateX(0px) translateY(-50px) rotateX(0deg) rotateY(0deg) scale(1.1);
            transform-origin: center center;
            opacity: 1 !important;
            animation: none; /* 拿出时停止波浪动画 */
        }

        /* `.is-open` 类：当书本封面被点击“翻开”时的状态 */
        .front-cover.is-open {
            transform: rotateY(160deg) translateZ(calc(var(--book-thickness) / 2)); /* 调整旋转角度，使其向右前方翻开 */
        }

        /* 新增：书本过渡到全屏页面视图时的状态 */
        .book-shelf-item.is-transitioning-to-page {
            /* 移动到中心，放大，并完全正对用户 */
            transform: translate(-50%, -50%) rotateX(0deg) rotateY(0deg) scale(3); /* 调整 scale 以适应屏幕 */
            width: 100vw; /* 占据整个视口宽度 */
            height: 100vh; /* 占据整个视口高度 */
            max-width: none; /* 移除最大宽度限制 */
            max-height: none; /* 移除最大高度限制 */
            border-radius: 0; /* 移除圆角 */
            background-color: #1a202c; /* 与背景色一致，模拟全屏 */
            z-index: 101; /* 确保在所有内容之上 */
            transition: transform 1.5s ease-in-out, width 1.5s ease-in-out, height 1.5s ease-in-out, background-color 1.5s ease-in-out, border-radius 1.5s ease-in-out; /* 平滑过渡所有属性 */
            opacity: 1; /* 确保完全可见 */
            pointer-events: none; /* 确保不阻碍点击 */
        }

        /* 当书本过渡时，其容器也应调整 */
        .book-shelf-item.is-transitioning-to-page .book-container {
            width: 100%;
            height: 100%;
            transform: translateX(0); /* 移除书脊偏移 */
            transition: transform 1.5s ease-in-out;
        }

        /* 当书本过渡时，封面完全打开并平铺 */
        .book-shelf-item.is-transitioning-to-page .front-cover {
            transform: rotateY(180deg) translateZ(0); /* 完全翻开并与书页对齐 */
            width: 50%; /* 封面占据一半宽度 */
            height: 100%;
            left: 0; /* 定位到左侧 */
            border-radius: 0;
            transition: transform 1.5s ease-in-out, width 1.5s ease-in-out, left 1.5s ease-in-out, border-radius 1.5s ease-in-out;
        }

        /* 当书本过渡时，书页平铺到右侧 */
        .book-shelf-item.is-transitioning-to-page .book-pages {
            width: 50%; /* 书页占据一半宽度 */
            height: 100%;
            left: 50%; /* 定位到右侧 */
            top: 0;
            border-radius: 0;
            animation: pageTurnAnimation 0.3s linear infinite; /* 快速、连续翻页动画 */
            transition: width 1.5s ease-in-out, left 1.5s ease-in-out, height 1.5s ease-in-out, border-radius 1.5s ease-in-out;
        }

        /* 当书本过渡时，隐藏书脊和右侧 */
        .book-shelf-item.is-transitioning-to-page .book-spine,
        .book-shelf-item.is-transitioning-to-page .book-right-side,
        .book-shelf-item.is-transitioning-to-page .back-cover {
            opacity: 0; /* 隐藏书脊和封底 */
            transition: opacity 0.5s ease-out;
        }


        /* 书页翻动动画的关键帧（修改为连续循环） */
        @keyframes pageTurnAnimation {
            0% {
                transform: translateZ(calc(var(--book-thickness) / 2 + 1px)) scaleX(1);
                background-color: #f8f8f8;
            }
            50% {
                transform: translateZ(calc(var(--book-thickness) / 2 + 3px)) scaleX(0.98); /* 模拟页面轻微收缩 */
                background-color: #e0e0e0; /* 模拟页面颜色变化 */
            }
            100% {
                transform: translateZ(calc(var(--book-thickness) / 2 + 1px)) scaleX(1);
                background-color: #f8f8f8;
            }
        }


        /*
            模态框（弹出窗口）样式：
            用于显示书籍的详细内容和操作按钮。
        */
        .modal-overlay {
            display: none; /* 默认隐藏 */
            position: fixed; /* 固定定位，覆盖整个视口 */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* 半透明黑色背景 */
            z-index: 100; /* 确保在最上层 */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto; /* 内容过多时可滚动 */
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transform: scale(0.8); /* 初始缩小 */
            opacity: 0; /* 初始透明 */
            transition: transform 0.3s ease-out, opacity 0.3s ease-out; /* 动画过渡 */
        }

        .modal-overlay.show .modal-content {
            transform: scale(1); /* 显示时放大 */
            opacity: 1; /* 显示时完全不透明 */
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            transition: color 0.2s;
        }
        .modal-close:hover {
            color: #333;
        }

        /* 暗黑模式下的模态框 */
        .dark .modal-content {
            background-color: #1f2937; /* gray-800 */
            color: #d1d5db; /* gray-300 */
        }
        .dark .modal-close {
            color: #d1d5db;
        }
        .dark .modal-close:hover {
            color: #ffffff;
        }

        /* 书架视觉效果 */
        .bookshelf-row {
            background-color: #a0522d; /* 棕色木头颜色 */
            height: 20px; /* 书架板厚度 */
            width: 100%;
            max-width: 1000px; /* 限制书架宽度 */
            border-radius: 5px;
            margin-top: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1; /* 确保书架在书本后面 */
        }
        .bookshelf-row::before,
        .bookshelf-row::after {
            content: '';
            position: absolute;
            height: 100%;
            width: 10px; /* 侧边支撑 */
            background-color: #8B4513; /* 深棕色 */
            top: 0;
            border-radius: 3px;
        }
        .bookshelf-row::before {
            left: -10px;
        }
        .bookshelf-row::after {
            right: -10px;
        }

        /* 书籍显示区域：用于控制每行书籍的布局和数量 */
        .bookshelf-books-display {
            display: flex;
            flex-wrap: wrap; /* 允许书籍换行 */
            justify-content: center; /* 水平居中书籍 */
            align-items: flex-end; /* 将书籍底部对齐到书架底部 */
            width: 100%;
            max-width: 1000px; /* 限制书籍显示区域的最大宽度，间接控制每行书籍数量 */
            margin: -1rem auto 0 auto; /* 调整负边距，使书籍底部“坐”在书架板上 */
            padding: 0 20px; /* 左右内边距 */
            position: relative;
            z-index: 10;
            min-height: var(--book-actual-height); /* 确保行有足够高度容纳书籍 */
        }

        /* 背景模糊效果 */
        .main-blurred {
            filter: blur(5px); /* 应用5px的高斯模糊 */
            transition: filter 0.3s ease-out; /* 平滑过渡效果 */
        }

        /* 搜索框样式 */
        .search-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
            gap: 0.5rem;
            width: 100%; /* 确保搜索容器响应式 */
            max-width: 600px; /* 限制最大宽度 */
            margin-left: auto;
            margin-right: auto;
        }
        .search-input {
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            flex-grow: 1; /* 允许输入框填充可用空间 */
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            background-color: #fff; /* 亮色模式背景 */
            color: #333; /* 亮色模式文本 */
        }
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .search-button, .clear-button {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease-in-out, transform 0.3s ease-in-out;
            white-space: nowrap; /* 防止按钮文本换行 */
        }
        .search-button {
            background-color: #3b82f6;
            color: white;
            border: none;
        }
        .search-button:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }
        .clear-button {
            background-color: #ef4444;
            color: white;
            border: none;
        }
        .clear-button:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }

        /* 暗黑模式下的搜索框 */
        .dark .search-input {
            background-color: #374151;
            border-color: #4b5563;
            color: #d1d5db;
        }
        .dark .search-input:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
        }

        /* 悬停预览面板样式 */
        .book-hover-preview {
            position: fixed;
            top: 0;
            left: -300px; /* 默认隐藏在左侧 */
            width: 280px; /* 预览面板宽度 */
            max-width: 80%; /* 响应式调整 */
            height: 100%;
            padding: 2rem 1.5rem;
            z-index: 80; /* 在主内容之上，在详情面板之下 */
            transition: left 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0; /* 默认透明 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* 垂直居中内容 */
            text-align: center;
            pointer-events: none; /* 确保鼠标事件穿透到下面的书本 */
        }
        .book-hover-preview.show {
            left: 0; /* 显示时滑入 */
            opacity: 1; /* 完全不透明 */
        }
        .book-hover-preview .preview-cover {
            width: 120px;
            height: 168px; /* 保持封面比例 */
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-bottom: 1rem;
        }
        .book-hover-preview h4 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #e2e8f0; /* 适应暗黑模式 */
        }
        .book-hover-preview p {
            font-size: 0.9rem;
            color: #cbd5e1; /* 适应暗黑模式 */
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 4; /* 限制简介行数 */
            -webkit-box-orient: vertical;
        }

        /* 左侧信息面板样式 (现在是详情面板) */
        .book-details-panel { /* 重命名为 book-details-panel */
            position: fixed;
            top: 0;
            left: -100%; /* 初始状态隐藏在左侧 */
            width: 350px; /* 面板宽度 */
            max-width: 90%; /* 响应式调整 */
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
            z-index: 90; /* 在主内容之上，在模态框之下 */
            transition: left 0.4s ease-out;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto; /* 内容过多时可滚动 */
            border-right: 1px solid rgba(209, 213, 219, 0.3);
            color: #333; /* 亮色模式文本 */
        }
        .book-details-panel.show {
            left: 0; /* 显示时滑入 */
        }
        .book-details-panel .close-panel-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.8rem;
            cursor: pointer;
            color: #666;
            transition: color 0.2s;
        }
        .book-details-panel .close-panel-btn:hover {
            color: #333;
        }
        .book-details-panel .book-cover-display {
            width: 180px;
            height: 252px; /* 保持封面比例 */
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 1.5rem;
            flex-shrink: 0; /* 防止封面缩小 */
        }
        .book-details-panel h3 {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .book-details-panel p {
            text-align: center;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        .book-details-panel .panel-buttons {
            display: flex;
            gap: 1rem;
            margin-top: auto; /* 推到底部 */
        }

        /* 暗黑模式下的左侧信息面板 */
        .dark .book-details-panel {
            background-color: rgba(31, 41, 55, 0.95); /* gray-800 */
            color: #d1d5db; /* gray-300 */
            border-color: rgba(75, 85, 99, 0.3);
        }
        .dark .book-details-panel .close-panel-btn {
            color: #d1d5db;
        }
        .dark .book-details-panel .close-panel-btn:hover {
            color: #ffffff;
        }

        /* 媒体查询：小屏幕适配 */
        @media (max-width: 768px) {
            .book-details-panel, .book-hover-preview {
                width: 100%; /* 小屏幕下全宽 */
                padding: 1.5rem;
            }
            .book-details-panel .book-cover-display {
                width: 150px;
                height: 210px;
            }
            .book-details-panel h3 {
                font-size: 1.5rem;
            }
            .book-details-panel p {
                font-size: 0.9rem;
            }
        }

        /* 滚动到顶部按钮 */
        #scrollToTopBtn {
            display: none; /* 默认隐藏 */
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 99;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
        }
        #scrollToTopBtn:hover {
            background-color: #2563eb;
        }
        #scrollToTopBtn.show {
            display: flex; /* 使用flexbox居中图标 */
            justify-content: center;
            align-items: center;
        }

        /* 类别筛选按钮样式 */
        .category-button {
            padding: 0.5rem 1rem;
            border-radius: 9999px; /* pill shape */
            background-color: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
            border: 1px solid rgba(209, 213, 219, 0.1);
        }
        .category-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .category-button.active {
            background-color: #3b82f6;
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="text-gray-800 dark:bg-gray-900 dark:text-gray-200">

    <!--
        -------------------------------------------------------------------
        顶部导航栏 (Navbar) 部分：
        与主页保持一致，提供统一的导航体验。
        -------------------------------------------------------------------
    -->
    <nav id="navbar" class="fixed top-0 left-0 right-0 z-50 bg-gray-900 bg-opacity-70 backdrop-filter backdrop-blur-lg shadow-sm transition-all duration-300 ease-in-out">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="personal-homepage.html" class="text-2xl font-bold text-blue-400">我的主页</a>
            
            <div class="hidden md:flex space-x-6">
                <a href="my-bookshelf.html" class="text-gray-300 hover:text-blue-400 transition duration-300">我的书架</a>
                <a href="solar_system_map.html" class="text-gray-300 hover:text-blue-400 transition duration-300 flex items-center">
                    <i class="fas fa-globe-americas mr-2"></i> 返回太阳系图
                </a>
            </div>

            <div class="flex items-center space-x-4">
                <button class="text-gray-300 hover:text-blue-400 transition duration-300">
                    <i class="fas fa-search"></i> </button>
                <button class="text-gray-300 hover:text-blue-400 transition duration-300">
                    <i class="fas fa-user"></i> </button>
                <button id="theme-toggle" class="text-gray-300 hover:text-blue-400 transition duration-300">
                    <i class="fas fa-moon"></i> </button>
                <button id="mobile-menu-button" class="md:hidden text-gray-300 hover:text-blue-400 transition duration-300">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </nav>

    <div id="mobile-menu" class="mobile-menu">
        <button id="close-mobile-menu" class="close-btn"><i class="fas fa-times"></i></button>
        <a href="personal-homepage.html" class="text-gray-300 hover:text-blue-400 transition duration-300">返回主页</a>
        <a href="my-bookshelf.html" class="text-gray-300 hover:text-blue-400 transition duration-300">我的书架</a>
        <a href="solar_system_map.html" class="text-gray-300 hover:text-blue-400 transition duration-300 flex items-center justify-center">
            <i class="fas fa-globe-americas mr-2"></i> 返回太阳系图
        </a>
        <button class="text-gray-300 hover:text-blue-400 transition duration-300">
            <i class="fas fa-search"></i> 搜索
        </button>
        <button class="text-gray-300 hover:text-blue-400 transition duration-300">
            <i class="fas fa-user"></i> 登录
        </button>
        <button id="mobile-theme-toggle" class="text-gray-300 hover:text-blue-400 transition duration-300">
            <i class="fas fa-moon"></i> 主题
        </button>
    </div>

    <!--
        -------------------------------------------------------------------
        主视觉区域 (Hero Section)：
        用于展示页面标题和Three.js背景。
        -------------------------------------------------------------------
    -->
    <header class="hero-background relative">
        <canvas id="threejs-background"></canvas>
        <div class="absolute inset-0 bg-black opacity-30 z-10"></div>
        <div class="relative z-20 text-center text-white p-6 rounded-lg glass-morphism">
            <h1 class="text-5xl font-extrabold mb-2">我的书架</h1>
            <p class="text-xl max-w-2xl mx-auto">探索我的知识宝库</p>
        </div>
    </header>

    <!--
        -------------------------------------------------------------------
        书架内容区域 (Main Content Section)：
        展示书籍列表，每本书都可点击并触发3D打开效果。
        -------------------------------------------------------------------
    -->
    <main id="main-content" class="container mx-auto px-4 py-12 relative z-20">
        <h2 class="text-4xl font-bold text-gray-100 mb-8 text-center">我的精选藏书</h2>
        
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="搜索书名、作者或简介..." class="search-input">
            <button id="searchButton" class="search-button">
                <i class="fas fa-search"></i> 搜索
            </button>
            <button id="clearSearchButton" class="clear-button">
                <i class="fas fa-times"></i> 清除
            </button>
        </div>

        <div class="flex flex-wrap justify-center gap-3 mb-8">
            <button class="category-button active" data-category="all">全部</button>
            <button class="category-button" data-category="前端开发">前端开发</button>
            <button class="category-button" data-category="AI">AI</button>
            <button class="category-button" data-category="物理">物理</button>
            <button class="category-button" data-category="个人成长">个人成长</button>
            </div>

        <div class="flex flex-col items-center">
            <div id="bookshelf-display-area" class="w-full flex flex-col items-center">
                </div>
        </div>
    </main>

    <!--
        -------------------------------------------------------------------
        悬停预览面板 (Book Hover Preview)：
        鼠标悬停在书本上时从左侧滑入，展示书籍简要信息。
        -------------------------------------------------------------------
    -->
    <div id="bookHoverPreview" class="book-hover-preview glass-morphism">
        <div class="preview-cover" id="previewBookCover"></div>
        <h4 id="previewBookTitle"></h4>
        <p id="previewBookAuthor"></p>
        <p id="previewBookSummary"></p>
    </div>

    <!--
        -------------------------------------------------------------------
        左侧信息面板 (Book Details Panel)：
        点击书本后从左侧滑入，展示书籍详细信息。
        -------------------------------------------------------------------
    -->
    <div id="bookDetailsPanel" class="book-details-panel"> <span class="close-panel-btn">&times;</span>
        <div class="book-cover-display" id="panelBookCover"></div>
        <h3 id="panelBookTitle" class="text-gray-900 dark:text-white"></h3>
        <p id="panelBookAuthor" class="text-gray-700 dark:text-gray-300"></p>
        <p id="panelBookSummary" class="text-gray-800 dark:text-gray-200"></p>
        <div class="panel-buttons">
            <button id="panelCloseBtn" class="px-6 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition duration-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 btn-primary">
                关闭
            </button>
            <button id="panelGoToDetailsBtn" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-bold shadow-md hover:bg-blue-700 transition duration-300 btn-primary">
                进入详情页
            </button>
        </div>
    </div>

    <!--
        -------------------------------------------------------------------
        底部 (Footer) 部分：
        与主页保持一致。
        -------------------------------------------------------------------
    -->
    <footer class="bg-gray-900 text-white py-8 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="mb-2">我的主页 © 2024</p>
            <p class="mb-2">你的备案号 (如果需要)</p>
            <p class="text-sm">Designed by <a href="#" class="text-blue-400 hover:underline">你的名字</a></p>
            <p class="text-sm">Powered by HTML/CSS/Three.js</p>
        </div>
    </footer>

    <button id="scrollToTopBtn" title="回到顶部">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!--
        -------------------------------------------------------------------
        JavaScript 脚本部分：
        用于实现页面的交互和动态效果，包括暗黑模式、导航栏、Three.js背景和书籍3D效果。
        -------------------------------------------------------------------
    -->
    <script>
        /*
            暗黑模式切换功能：
            与主页功能一致，控制页面的亮色/暗色主题。
        */
        const themeToggle = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement;

        function applyTheme(isDark) {
            if (isDark) {
                htmlElement.classList.add('dark');
                themeToggle.querySelector('i').classList.replace('fa-moon', 'fa-sun');
            } else {
                htmlElement.classList.remove('dark');
                themeToggle.querySelector('i').classList.replace('fa-sun', 'fa-moon');
            }
        }

        themeToggle.addEventListener('click', () => {
            applyTheme(!htmlElement.classList.contains('dark'));
            localStorage.setItem('theme', htmlElement.classList.contains('dark') ? 'dark' : 'light');
        });

        // 根据本地存储设置初始主题
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            applyTheme(true);
        } else {
            applyTheme(false);
        }

        /*
            导航栏滚动效果：
            当页面向下滚动超过一定距离时，导航栏会添加一个 `navbar-scrolled` 类，
            从而改变其背景和阴影，使其更突出。
        */
        const navbar = document.getElementById('navbar');
        window.addEventListener('scroll', () => {
            if (window.scrollY > 50) {
                navbar.classList.add('navbar-scrolled');
            } else {
                navbar.classList.remove('navbar-scrolled');
            }
        });

        /*
            移动端菜单切换功能
        */
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeMobileMenuButton = document.getElementById('close-mobile-menu');
        const mobileThemeToggle = document.getElementById('mobile-theme-toggle'); // 移动端主题切换按钮

        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.add('open');
        });

        closeMobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.remove('open');
        });

        mobileThemeToggle.addEventListener('click', () => {
            applyTheme(!htmlElement.classList.contains('dark'));
            localStorage.setItem('theme', htmlElement.classList.contains('dark') ? 'dark' : 'light');
        });


        /*
            -------------------------------------------------------------------
            Three.js 3D 场景设置和动画：
            创建并管理背景中的动态粒子效果。
            -------------------------------------------------------------------
        */
        let scene, camera, renderer, particles, backgroundSphere, mouseX = 0, mouseY = 0;
        const canvas = document.getElementById('threejs-background');
        const textureLoader = new THREE.TextureLoader();

        function initThreeJS() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            const particleCount = 1500;

            for (let i = 0; i < particleCount; i++) {
                const x = (Math.random() - 0.5) * 40;
                const y = (Math.random() - 0.5) * 40;
                const z = (Math.random() - 0.5) * 40;
                vertices.push(x, y, z);
            }
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));

            const material = new THREE.PointsMaterial({
                color: 0x00FFFF,
                size: 0.08,
                transparent: true,
                opacity: 0.8
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            const backgroundSphereGeometry = new THREE.SphereGeometry(500, 32, 32);
            const backgroundTexture = textureLoader.load('https://raw.githubusercontent.com/cooperhuang1/cooperhuang1.github.io/main/textures/8k_stars_milky_way.jpg');
            const backgroundMaterial = new THREE.MeshBasicMaterial({
                map: backgroundTexture,
                side: THREE.BackSide
            });
            backgroundSphere = new THREE.Mesh(backgroundSphereGeometry, backgroundMaterial);
            scene.add(backgroundSphere);

            document.addEventListener('mousemove', onDocumentMouseMove);
            window.addEventListener('resize', onWindowResize);
        }

        function onDocumentMouseMove(event) {
            mouseX = (event.clientX - window.innerWidth / 2) / 200;
            mouseY = (event.clientY - window.innerHeight / 2) / 200;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animateThreeJS() {
            requestAnimationFrame(animateThreeJS);

            particles.rotation.x += 0.0005;
            particles.rotation.y += 0.001;

            if (backgroundSphere) {
                backgroundSphere.rotation.y += 0.0001;
            }

            camera.position.x += (mouseX - camera.position.x) * 0.05;
            camera.position.y += (-mouseY - camera.position.y) * 0.05;
            camera.lookAt(scene.position);

            renderer.render(scene, camera);
        }

        /*
            -------------------------------------------------------------------
            书籍数据、3D交互、信息面板和搜索/过滤功能：
            -------------------------------------------------------------------
        */
        // 书籍数据数组
        const booksData = [
            {
                title: "太阳系边际探索",
                author: "黄俊鑫 孙导航",
                // 修复：将相对路径替换为绝对路径或占位符 URL，以避免 'Failed to set the 'href' property on 'Location'' 错误。
                // 在实际部署中，请确保这些 URL 指向有效的页面。
                pageUrl: "https://cooperhuang1.github.io/sun_explorer.html",
                summary: "本书详细介绍了Vue.js的核心概念、组件化开发、状态管理以及性能优化等内容，是前端开发者学习Vue的必备指南。",
                coverUrl: "https://placehold.co/200x280/FFD700/000000?text=Vue.js+Book",
                spineText: "Vue.js",
                category: "前端开发"
            },
            {
                title: "流体力学",
                author: "李四",
                pageUrl: "https://cooperhuang1.github.io/liutilixue.pdf",
                summary: "本书从Hooks、Context API到性能优化、服务端渲染，全面讲解React高级特性，助你成为React专家。",
                coverUrl: "https://placehold.co/200x280/87CEEB/000000?text=React+Book",
                spineText: "React",
                category: "前端开发"
            },
            {
                title: "JavaScript设计模式",
                author: "王五",
                pageUrl: "https://example.com/js-design-patterns.pdf",
                summary: "探索JavaScript中常用的设计模式，提升代码的可维护性和扩展性，编写更优雅的JavaScript代码。这是一个PDF示例。",
                coverUrl: "https://placehold.co/200x280/FF6347/ffffff?text=JS+Patterns",
                spineText: "JS设计模式",
                category: "前端开发"
            },
            {
                title: "CSS揭秘",
                author: "赵六",
                pageUrl: "https://example.com/css-secrets.html",
                summary: "本书揭示了CSS的许多不为人知的技巧和高级用法，让你能够创作出更具创意和表现力的网页界面。",
                coverUrl: "https://placehold.co/200x280/90EE90/000000?text=CSS+Secrets",
                spineText: "CSS揭秘",
                category: "前端开发"
            },
            {
                title: "Web性能优化",
                author: "钱七",
                pageUrl: "https://example.com/web-performance.pdf",
                summary: "从网络、渲染到资源加载，全面讲解Web性能优化策略，提升用户体验和网站加载速度。这是一个PDF示例。",
                coverUrl: "https://placehold.co/200x280/DA70D6/ffffff?text=Web+Perf",
                spineText: "Web性能",
                category: "前端开发"
            },
            {
                title: "深度学习",
                author: "伊恩·古德费洛等",
                pageUrl: "https://example.com/deep-learning.html",
                summary: "深度学习领域的“圣经”，全面涵盖了深度学习的理论、算法和应用。",
                coverUrl: "https://placehold.co/200x280/5F9EA0/000000?text=Deep+Learning",
                spineText: "深度学习",
                category: "AI"
            },
            {
                title: "原子习惯",
                author: "詹姆斯·克利尔",
                pageUrl: "https://example.com/atomic-habits.html",
                summary: "通过微小改变，养成良好习惯，实现个人成长的实用指南。",
                coverUrl: "https://placehold.co/200x280/FFB6C1/000000?text=Atomic+Habits",
                spineText: "原子习惯",
                category: "个人成长"
            },
            {
                title: "宇宙的琴弦",
                author: "布莱恩·格林",
                pageUrl: "https://example.com/elegant-universe.html",
                summary: "一本深入浅出地介绍弦理论的科普巨著，带你领略宇宙最深层的奥秘。",
                coverUrl: "https://placehold.co/200x280/ADD8E6/000000?text=Elegant+Universe",
                spineText: "宇宙的琴弦",
                category: "物理"
            },
            // 添加更多书籍...
        ];

        const bookshelfDisplayArea = document.getElementById('bookshelf-display-area');
        const bookDetailsPanel = document.getElementById('bookDetailsPanel'); // 重命名
        const closeDetailsPanelBtn = bookDetailsPanel.querySelector('.close-panel-btn'); // 重命名
        const panelBookCover = document.getElementById('panelBookCover');
        const panelBookTitle = document.getElementById('panelBookTitle');
        const panelBookAuthor = document.getElementById('panelBookAuthor');
        const panelBookSummary = document.getElementById('panelBookSummary');
        const panelGoToDetailsBtn = document.getElementById('panelGoToDetailsBtn');
        const mainContent = document.getElementById('main-content');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const clearSearchButton = document.getElementById('clearSearchButton');
        const categoryButtons = document.querySelectorAll('.category-button');
        const scrollToTopBtn = document.getElementById('scrollToTopBtn');

        // 新增悬停预览面板元素
        const bookHoverPreview = document.getElementById('bookHoverPreview');
        const previewBookCover = document.getElementById('previewBookCover');
        const previewBookTitle = document.getElementById('previewBookTitle');
        const previewBookAuthor = document.getElementById('previewBookAuthor');
        const previewBookSummary = document.getElementById('previewBookSummary');


        let activeBook = null; // 存储当前被激活的书本元素
        let currentCategory = 'all'; // 当前选中的分类

        // 渲染书籍到书架
        function renderBooks(booksToRender) {
            bookshelfDisplayArea.innerHTML = ''; // 清空现有书籍
            const booksPerRow = 4; // 每行显示的书籍数量 (可根据设计调整)
            let currentRowContainer = null;
            let currentBookCount = 0;

            // 添加顶部的书架板
            const topShelfRow = document.createElement('div');
            topShelfRow.classList.add('bookshelf-row');
            bookshelfDisplayArea.appendChild(topShelfRow);

            const bookDisplayDiv = document.createElement('div');
            bookDisplayDiv.classList.add('bookshelf-books-display');
            bookshelfDisplayArea.appendChild(bookDisplayDiv);
            currentRowContainer = bookDisplayDiv;


            booksToRender.forEach((bookData, index) => {
                // 如果当前行已满，或不是第一本书，则创建新行
                if (currentBookCount >= booksPerRow) {
                    const newShelfRow = document.createElement('div');
                    newShelfRow.classList.add('bookshelf-row');
                    bookshelfDisplayArea.appendChild(newShelfRow);

                    const newBookDisplayDiv = document.createElement('div');
                    newBookDisplayDiv.classList.add('bookshelf-books-display');
                    bookshelfDisplayArea.appendChild(newBookDisplayDiv);
                    currentRowContainer = newBookDisplayDiv;
                    currentBookCount = 0; // 重置计数器
                }

                const bookItem = document.createElement('div');
                bookItem.classList.add('book-shelf-item');
                bookItem.setAttribute('data-title', bookData.title);
                bookItem.setAttribute('data-author', bookData.author);
                bookItem.setAttribute('data-page-url', bookData.pageUrl);
                bookItem.setAttribute('data-summary', bookData.summary);
                bookItem.setAttribute('data-cover-url', bookData.coverUrl);
                bookItem.setAttribute('data-spine-text', bookData.spineText);
                bookItem.setAttribute('data-category', bookData.category);

                bookItem.innerHTML = `
                    <div class="book-container">
                        <div class="book-body">
                            <div class="book-face back-cover"></div>
                            <div class="book-spine"></div>
                            <div class="book-right-side"></div>
                            <div class="book-pages"></div>
                        </div>
                        <div class="book-face front-cover"></div>
                    </div>
                `;

                // Set cover image
                bookItem.querySelector('.front-cover').style.backgroundImage = `url('${bookData.coverUrl}')`;
                // Set spine text
                bookItem.querySelector('.book-spine').textContent = bookData.spineText;

                // Bind event listeners
                setupBookEventListeners(bookItem);

                currentRowContainer.appendChild(bookItem);
                currentBookCount++;
            });

            // If the last row is not full, add a bottom shelf board
            if (booksToRender.length > 0) {
                const bottomShelfRow = document.createElement('div');
                bottomShelfRow.classList.add('bookshelf-row');
                bookshelfDisplayArea.appendChild(bottomShelfRow);
            }
        }

        // Setup event listeners for individual books
        function setupBookEventListeners(bookItem) {
            const frontCover = bookItem.querySelector('.front-cover');

            // Mouse hover to show preview panel
            bookItem.addEventListener('mouseenter', (e) => {
                // If the details panel is already open, do not show hover preview
                if (bookDetailsPanel.classList.contains('show')) {
                    return;
                }

                const bookData = bookItem.dataset;
                previewBookCover.style.backgroundImage = `url('${bookData.coverUrl}')`;
                previewBookTitle.textContent = bookData.title;
                previewBookAuthor.textContent = `作者: ${bookData.author}`;
                previewBookSummary.textContent = bookData.summary;
                
                bookHoverPreview.classList.add('show');
            });

            bookItem.addEventListener('mouseleave', () => {
                // Only hide hover preview if the details panel is not open
                if (!bookDetailsPanel.classList.contains('show')) {
                    bookHoverPreview.classList.remove('show');
                }
            });

            // Click book to trigger pull-out and open animation, and show details panel
            bookItem.addEventListener('click', () => {
                if (activeBook && activeBook !== bookItem) {
                    // If another book is active, close it first
                    resetBookState(activeBook);
                }

                activeBook = bookItem;
                const pageUrl = bookItem.dataset.pageUrl;

                // 1. Pull out book animation (book moves and turns to face forward)
                bookItem.classList.add('is-pulled-out');
                mainContent.classList.add('main-blurred'); // Blur background
                bookHoverPreview.classList.remove('show'); // Hide hover preview when clicked

                // 2. Open cover animation (starts during pull-out for more realistic transition)
                // The 150ms delay makes the cover start opening slightly after the pull-out begins,
                // creating an overlapping and smoother effect.
                setTimeout(() => {
                    frontCover.classList.add('is-open');
                }, 150); // Start opening cover after 150ms

                // 3. Show details panel (after both animations have progressed sufficiently)
                setTimeout(() => {
                    showBookDetailsPanel(bookItem.dataset);
                }, 1000); // Show panel after 1 second
            });
        }

        // Show book details panel
        function showBookDetailsPanel(bookData) {
            panelBookCover.style.backgroundImage = `url('${bookData.coverUrl}')`;
            panelBookTitle.textContent = bookData.title;
            panelBookAuthor.textContent = `作者: ${bookData.author}`;
            panelBookSummary.textContent = bookData.summary;
            
            // Set "Go to Details Page" button link
            if (bookData.pageUrl) {
                panelGoToDetailsBtn.onclick = () => {
                    // Hide the details panel immediately
                    bookDetailsPanel.classList.remove('show');
                    mainContent.classList.remove('main-blurred'); // Remove blur from main content

                    if (activeBook) {
                        const rect = activeBook.getBoundingClientRect();

                        // Set initial fixed position to current visual position
                        activeBook.style.position = 'fixed';
                        activeBook.style.top = `${rect.top}px`;
                        activeBook.style.left = `${rect.left}px`;
                        activeBook.style.width = `${rect.width}px`;
                        activeBook.style.height = `${rect.height}px`;
                        activeBook.style.margin = '0'; // Remove any margin that might interfere
                        activeBook.style.zIndex = '101'; // Ensure it's on top during transition

                        // Force reflow to ensure styles are applied before transition
                        activeBook.offsetWidth; // This is a common trick for reflow

                        // Now, apply the transition class to animate to the final state
                        // Use requestAnimationFrame for smoother visual update
                        requestAnimationFrame(() => {
                            activeBook.classList.add('is-transitioning-to-page');
                            // Ensure cover is fully open and pages are turning during this transition
                            activeBook.querySelector('.front-cover').classList.add('is-open'); // Ensure it's fully open
                            activeBook.querySelector('.book-pages').classList.add('is-turning-pages'); // Start continuous page turning
                        });
                    }
                    
                    // After the animation, navigate to the details page
                    // The transition is 1.5s, so wait slightly longer for a smooth visual.
                    setTimeout(() => {
                        // Reset the book's fixed positioning before navigation to prevent visual glitches
                        if (activeBook) {
                            activeBook.style.position = ''; // Revert to original positioning
                            activeBook.style.top = '';
                            activeBook.style.left = '';
                            activeBook.style.width = '';
                            activeBook.style.height = '';
                            activeBook.style.margin = '';
                            activeBook.style.zIndex = ''; // Reset z-index
                            resetBookState(activeBook); // Ensure all animation classes are removed
                        }
                        window.location.href = bookData.pageUrl;
                    }, 1800); // Wait for 1.8 seconds (transition duration + buffer)
                };
                panelGoToDetailsBtn.style.display = 'inline-flex'; // Show button
            } else {
                panelGoToDetailsBtn.style.display = 'none'; // Hide button
            }

            bookDetailsPanel.classList.add('show');
        }

        // Close book details panel and reset book state
        function closeBookDetailsPanel() {
            bookDetailsPanel.classList.remove('show');
            mainContent.classList.remove('main-blurred'); // Remove blur
            if (activeBook) {
                resetBookState(activeBook);
            }
            activeBook = null; // Clear active book
        }

        // Reset individual book's 3D state
        function resetBookState(bookItem) {
            const frontCover = bookItem.querySelector('.front-cover');
            const bookPages = bookItem.querySelector('.book-pages'); // 获取书页元素
            
            frontCover.classList.remove('is-open');
            bookItem.classList.remove('is-pulled-out');
            bookItem.classList.remove('is-transitioning-to-page'); // 新增：移除过渡动画类
            if (bookPages) { // 确保元素存在再移除类
                bookPages.classList.remove('is-turning-pages'); // 新增：移除翻页动画类
            }
            // Ensure any inline styles from fixed positioning are cleared
            bookItem.style.position = '';
            bookItem.style.top = '';
            bookItem.style.left = '';
            bookItem.style.width = '';
            bookItem.style.height = '';
            bookItem.style.margin = '';
            bookItem.style.zIndex = '';
        }

        // Bind close details panel button events
        closeDetailsPanelBtn.addEventListener('click', closeBookDetailsPanel);
        panelCloseBtn.addEventListener('click', closeBookDetailsPanel);


        // Search function
        searchButton.addEventListener('click', () => filterAndRenderBooks(searchInput.value, currentCategory));
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                filterAndRenderBooks(searchInput.value, currentCategory);
            }
        });
        clearSearchButton.addEventListener('click', () => {
            searchInput.value = '';
            filterAndRenderBooks('', currentCategory); // Clear and re-filter
        });

        // Category filter function
        categoryButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons
                categoryButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to the clicked button
                button.classList.add('active');
                currentCategory = button.dataset.category; // Update current category
                filterAndRenderBooks(searchInput.value, currentCategory); // Re-filter and render
            });
        });

        // Combined filter and render function
        function filterAndRenderBooks(searchTerm, category) {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const filteredBooks = booksData.filter(book => {
                const matchesSearch = book.title.toLowerCase().includes(lowerCaseSearchTerm) ||
                                      book.author.toLowerCase().includes(lowerCaseSearchTerm) ||
                                      book.summary.toLowerCase().includes(lowerCaseSearchTerm);
                
                const matchesCategory = (category === 'all' || book.category === category);

                return matchesSearch && matchesCategory;
            });
            renderBooks(filteredBooks);
        }

        // Scroll to top button function
        window.addEventListener('scroll', () => {
            if (window.scrollY > 300) { // Show button when scrolled more than 300px
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }
        });

        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });


        // Initialize Three.js and book effects after page load
        window.onload = function () {
            initThreeJS();
            animateThreeJS();
            filterAndRenderBooks('', 'all'); // Initially load all books
        };
    </script>
</body>
</html>
